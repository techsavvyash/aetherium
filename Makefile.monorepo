.PHONY: help build test lint fmt clean docker-up docker-down deps install build-core build-gateway build-k8s-manager build-dashboard test-core test-gateway

help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘         Aetherium Monorepo Build System                   â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Building Services:"
	@echo "  make build              - Build all services"
	@echo "  make build-core         - Build core service only"
	@echo "  make build-gateway      - Build gateway service only"
	@echo "  make build-k8s-manager  - Build k8s-manager service only"
	@echo "  make build-dashboard    - Build dashboard only"
	@echo ""
	@echo "Testing:"
	@echo "  make test               - Test all services"
	@echo "  make test-core          - Test core service only"
	@echo "  make test-gateway       - Test gateway service only"
	@echo "  make test-coverage      - Generate coverage reports"
	@echo ""
	@echo "Code Quality:"
	@echo "  make lint               - Lint all services"
	@echo "  make fmt                - Format all code"
	@echo ""
	@echo "Infrastructure:"
	@echo "  make docker-build       - Build all Docker images"
	@echo "  make docker-up          - Start infrastructure (PostgreSQL, Redis)"
	@echo "  make docker-down        - Stop infrastructure"
	@echo ""
	@echo "Development:"
	@echo "  make deps               - Download all dependencies"
	@echo "  make clean              - Clean all build artifacts"
	@echo ""

# Building
build:
	@echo "ğŸ”¨ Building all services..."
	$(MAKE) build-core
	$(MAKE) build-gateway
	$(MAKE) build-k8s-manager
	@echo "âœ… All services built!"

build-core:
	@echo "ğŸ“¦ Building core service..."
	cd services/core && $(MAKE) build

build-gateway:
	@echo "ğŸ“¦ Building gateway service..."
	cd services/gateway && $(MAKE) build

build-k8s-manager:
	@echo "ğŸ“¦ Building k8s-manager service..."
	cd services/k8s-manager && $(MAKE) build

build-dashboard:
	@echo "ğŸ“¦ Building dashboard..."
	cd services/dashboard && npm run build

# Testing
test:
	@echo "ğŸ§ª Testing all services..."
	$(MAKE) test-core
	$(MAKE) test-gateway

test-core:
	@echo "ğŸ§ª Testing core service..."
	cd services/core && $(MAKE) test

test-gateway:
	@echo "ğŸ§ª Testing gateway service..."
	cd services/gateway && $(MAKE) test

test-coverage:
	@echo "ğŸ“Š Generating coverage reports..."
	cd services/core && $(MAKE) test-coverage
	cd services/gateway && $(MAKE) test-coverage

# Code Quality
lint:
	@echo "ğŸ” Linting all services..."
	cd services/core && $(MAKE) lint
	cd services/gateway && $(MAKE) lint
	cd services/k8s-manager && $(MAKE) lint

fmt:
	@echo "âœ¨ Formatting all code..."
	cd services/core && $(MAKE) fmt
	cd services/gateway && $(MAKE) fmt
	cd services/k8s-manager && $(MAKE) fmt

# Dependencies
deps:
	@echo "ğŸ“¥ Downloading dependencies..."
	go work sync
	cd services/core && $(MAKE) deps
	cd services/gateway && $(MAKE) deps
	cd services/k8s-manager && $(MAKE) deps
	cd libs/common && $(MAKE) deps 2>/dev/null || go mod tidy
	cd libs/types && $(MAKE) deps 2>/dev/null || go mod tidy

# Docker
docker-build:
	@echo "ğŸ³ Building Docker images..."
	docker-compose -f docker-compose.yml build

docker-up:
	@echo "ğŸš€ Starting infrastructure..."
	docker-compose -f docker-compose.yml up -d
	@echo "âœ… Infrastructure started!"

docker-down:
	@echo "ğŸ›‘ Stopping infrastructure..."
	docker-compose -f docker-compose.yml down

# Cleanup
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	cd services/core && $(MAKE) clean
	cd services/gateway && $(MAKE) clean
	cd services/k8s-manager && $(MAKE) clean
	rm -f coverage.out coverage.html
	go clean
	@echo "âœ… Cleanup complete!"

# Combined
install: deps build
	@echo "âœ… Installation complete!"
