# Squid Proxy Configuration for Aetherium VM Whitelist
# Purpose: Control internet access for VMs by whitelisting allowed domains

# Network configuration
http_port 3128

# Disable client-side features that cause issues in containerized environments
client_db off
strip_query_terms off

# ACL definitions
acl localnet src 172.16.0.0/16    # VM network subnet
acl localnet src 172.20.0.0/16    # Docker network subnet
acl SSL_ports port 443
acl Safe_ports port 80            # http
acl Safe_ports port 443           # https
acl Safe_ports port 21            # ftp
acl Safe_ports port 22            # ssh
acl Safe_ports port 1025-65535    # unregistered ports
acl CONNECT method CONNECT

# Load whitelist from file
acl whitelist dstdomain "/etc/squid/whitelist.txt"

# Deny requests to dangerous ports
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Define localhost ACL
acl localhost src 127.0.0.1/32 ::1

# Whitelist rules - ONLY allow whitelisted domains (both localnet and localhost must respect whitelist)
http_access allow localnet whitelist
http_access allow localhost whitelist
http_access deny all

# Deny all other requests
http_reply_access allow all

# Logging
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
cache_store_log /var/log/squid/store.log

# Cache configuration
cache_dir ufs /var/spool/squid 100 16 256
coredump_dir /var/spool/squid

# Performance tuning
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# Prevent hanging - critical timeouts
connect_timeout 30 seconds
read_timeout 60 seconds
request_timeout 60 seconds
persistent_request_timeout 60 seconds
client_lifetime 60 minutes
pconn_timeout 60 seconds
half_closed_clients off
shutdown_lifetime 10 seconds

# Allow direct connections to internet
# (Comment out never_direct - we want Squid to connect directly)
# never_direct allow all

# DNS settings - use system resolver
dns_timeout 10 seconds

# Disable cache for testing (can be enabled later)
cache deny all
