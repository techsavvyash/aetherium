{{- if .Values.configMap.create }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "aetherium.configMapName" . }}
  labels:
    {{- include "aetherium.labels" . | nindent 4 }}
data:
  config.yaml: |
    # Aetherium Configuration
    # Generated by Helm

    server:
      host: {{ .Values.config.server.host | quote }}
      port: {{ .Values.config.server.port }}
      graceful_shutdown: {{ .Values.config.server.gracefulShutdown | quote }}

    vmm:
      provider: {{ .Values.config.vmm.provider | quote }}
      firecracker:
        kernel_path: {{ .Values.config.vmm.firecracker.kernelPath | quote }}
        rootfs_template: {{ .Values.config.vmm.firecracker.rootfsTemplate | quote }}
        socket_dir: {{ .Values.config.vmm.firecracker.socketDir | quote }}
        default_vcpu: {{ .Values.config.vmm.firecracker.defaultVcpu }}
        default_memory_mb: {{ .Values.config.vmm.firecracker.defaultMemoryMb }}
      docker:
        socket_path: {{ .Values.config.vmm.docker.socketPath | quote }}
        default_image: {{ .Values.config.vmm.docker.defaultImage | quote }}

    queue:
      provider: {{ .Values.config.queue.provider | quote }}
      asynq:
        redis_addr: {{ include "aetherium.redis.host" . }}:{{ include "aetherium.redis.port" . }}
        concurrency: {{ .Values.config.queue.concurrency }}
        priorities:
          critical: {{ .Values.config.queue.priorities.critical }}
          high: {{ .Values.config.queue.priorities.high }}
          default: {{ .Values.config.queue.priorities.default }}
          low: {{ .Values.config.queue.priorities.low }}

    storage:
      provider: postgres
      postgres:
        host: {{ include "aetherium.postgresql.host" . }}
        port: {{ include "aetherium.postgresql.port" . }}
        {{- if .Values.postgresql.enabled }}
        database: {{ .Values.postgresql.auth.database | quote }}
        user: {{ .Values.postgresql.auth.username | quote }}
        {{- else }}
        database: {{ .Values.postgresql.external.database | quote }}
        {{- end }}
        ssl_mode: {{ if eq .Values.global.environment "production" }}require{{ else }}disable{{ end }}

    logging:
      provider: {{ .Values.config.logging.provider | quote }}
      level: {{ .Values.config.logging.level | quote }}
      {{- if .Values.loki.enabled }}
      loki:
        url: {{ .Values.loki.url | default "http://loki:3100" | quote }}
      {{- end }}

    tools:
      default:
        {{- range .Values.config.tools.default }}
        - {{ . | quote }}
        {{- end }}
      install_timeout: {{ .Values.config.tools.installTimeout | quote }}

    event_bus:
      provider: redis
      redis:
        addr: {{ include "aetherium.redis.host" . }}:{{ include "aetherium.redis.port" . }}
{{- end }}
